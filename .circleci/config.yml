version: 2
jobs:
  test:
    machine:
      - image: ubuntu-2004:202201-02
    steps:
      - checkout
      - run:
          command: |
            cd .circleci && ./run-tests.sh

  # publish jobs require $DOCKERHUB_REPO, $DOCKERHUB_USER, $DOCKERHUB_PASS defined

  docker:
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker
      - checkout
      - run:
          command: |
            docker login --username=$DOCKERHUB_USER --password=$DOCKERHUB_PASS
            LATEST_TAG=${CIRCLE_TAG:1} #trim v from tag
            docker buildx create --use
            docker buildx build -t $DOCKERHUB_REPO:$LATEST_TAG --platform linux/amd64,linux/arm64,linux/arm/v7 --push .

workflows:
  version: 2
  build_and_test:
    jobs:
      - test

  publish:
    jobs:
      - docker:
          filters:
            branches:
              ignore: /.*/
            # only act on version tags v1.0.0.88 or v1.0.2-1
            # OR feature tags like abc
            # OR features on specific versions like v1.0.0.88-abc-1
            tags:
              only: /(v[1-9]+(\.[0-9]+)*(-[a-z0-9-]+)?)|(v[a-z0-9-]+)/
